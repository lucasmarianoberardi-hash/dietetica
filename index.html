<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diet√©tica Virgilio - Pedidos</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --primary-color: #2e7d32;
            --secondary-color: #f1f8e9;
            --accent-color: #ffd600;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; padding: 0; background-color: #f4f4f4;
            opacity: 0; transition: opacity 0.5s;
        }

        /* --- Pantalla de Seguridad --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary-color); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999; color: white;
        }

        /* --- Barra Inferior --- */
        .navbar {
            position: fixed; bottom: 0; width: 100%; background: white;
            display: flex; justify-content: space-around; padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000;
        }

        .nav-item { cursor: pointer; text-align: center; font-size: 0.8em; color: var(--primary-color); }

        /* --- Productos --- */
        .container { padding: 20px; padding-bottom: 80px; max-width: 800px; margin: auto; }
        .category h2 { border-bottom: 2px solid var(--primary-color); color: var(--primary-color); padding-bottom: 5px; margin-top: 30px; }
        
        .producto {
            background: white; border-radius: 8px; margin-bottom: 15px; padding: 15px;
            display: flex; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .producto img { width: 100px; height: 100px; object-fit: cover; border-radius: 4px; }
        .producto-info { flex: 1; }

        /* --- L√≥gica de Pesables UI --- */
        .weight-input-container {
            display: flex; align-items: center; gap: 5px; margin: 10px 0;
        }
        .weight-input {
            width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-align: center;
        }
        .producto-actions button {
            padding: 8px 15px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;
        }

        /* --- Paneles --- */
        #cart, #qr-scanner-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; display: none; flex-direction: column; z-index: 2000;
            padding: 20px; box-sizing: border-box;
        }

        .notification {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; z-index: 3000;
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2>DIET√âTICA VIRGILIO</h2>
        <form id="login-form" style="display: flex; flex-direction: column; align-items: center;">
            <input type="password" id="security-input" name="password" placeholder="C√≥digo de acceso" 
                   style="padding: 12px; border-radius: 8px; border: none; margin-bottom: 10px; text-align: center;">
            <button type="submit" style="padding: 10px 25px; background-color: var(--accent-color); color: #333; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                ACCEDER
            </button>
        </form>
        <p id="error-message" style="color: #ffcdd2; display: none; margin-top: 15px;">C√≥digo incorrecto.</p>
    </div>

    <div class="container">
        <input type="text" id="search" placeholder="üîç Buscar productos..." style="width: 100%; padding: 12px; border-radius: 25px; border: 1px solid #ddd; display: none; margin-bottom: 15px;">
        <div id="products"></div>
    </div>

    <div id="qr-scanner-container">
        <div id="reader"></div>
        <button id="close-qr-scanner" style="margin-top: 20px; padding: 15px; background: #666; color: white; border: none;">Cerrar C√°mara</button>
    </div>

    <div id="cart">
        <h2 style="color: var(--primary-color);">Tu Pedido</h2>
        <ul id="cart-items" style="list-style: none; padding: 0; flex: 1; overflow-y: auto;"></ul>
        <div id="cart-summary">
            <h3>Total: $<span id="cart-total">0.00</span></h3>
            <button id="send-order-button" style="width: 100%; padding: 15px; background: #25d366; color: white; border: none; font-weight: bold;">PEDIR POR WHATSAPP</button>
            <button id="close-cart-button" style="width: 100%; margin-top: 10px; padding: 10px; border: none; background: #eee;">CERRAR</button>
        </div>
    </div>

    <nav class="navbar">
        <div class="nav-item" id="category-icon">üìÇ<br>Categor√≠as</div>
        <div class="nav-item" id="search-icon">üîç<br>Buscar</div>
        <div class="nav-item" id="qr-scan-icon">üì∑<br>Escanear</div>
        <div class="nav-item" id="cart-icon">üõí<br>Carrito<span id="cart-count" style="display:none; background:red; color:white; border-radius:50%; padding:2px 6px; font-size:10px;">0</span></div>
    </nav>

    <div id="category-menu" style="display:none; position:fixed; bottom:60px; left:0; width:100%; background:white; z-index:900; border-top:1px solid #ddd; max-height: 50vh; overflow-y: auto;">
        <ul id="category-list" style="list-style:none; padding:20px; margin:0;"></ul>
    </div>

    <script>
        // --- PEGA AQU√ç TUS URLS DE GOOGLE SHEETS ---
        const productsUrl = 'TU_CSV_DE_PRODUCTOS_AQUI';
        const securityCodeUrl = 'TU_URL_DE_CODIGO_SEGURIDAD_AQUI';

        let allProducts = [];
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let html5QrcodeScanner = null;

        // Seguridad
        async function checkSecurity() {
            try {
                const res = await fetch(securityCodeUrl);
                const code = (await res.text()).trim().toUpperCase();
                
                document.getElementById('login-form').onsubmit = (e) => {
                    e.preventDefault();
                    const input = document.getElementById('security-input').value.toUpperCase();
                    if(input === code) {
                        document.getElementById('login-screen').style.display = 'none';
                        document.body.style.opacity = '1';
                        loadData();
                    } else {
                        document.getElementById('error-message').style.display = 'block';
                    }
                };
            } catch (e) { document.body.style.opacity = '1'; loadData(); }
        }

        async function loadData() {
            try {
                const res = await fetch(productsUrl);
                const csv = await res.text();
                allProducts = parseCSV(csv);
                renderProducts(allProducts);
                renderCategories();
                updateCartUI();
            } catch (error) { console.error("Error cargando CSV"); }
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map(line => {
                const values = line.split(',');
                let obj = {};
                headers.forEach((h, i) => obj[h] = values[i]?.trim().replace(/^"|"$/g, ''));
                return obj;
            }).filter(p => p['Nombre del Producto']);
        }

        function renderProducts(list) {
            const container = document.getElementById('products');
            container.innerHTML = '';
            const groups = list.reduce((acc, p) => {
                acc[p.Categor√≠a] = acc[p.Categor√≠a] || [];
                acc[p.Categor√≠a].push(p);
                return acc;
            }, {});

            for (const cat in groups) {
                const section = document.createElement('div');
                section.innerHTML = `<h2 id="cat-${cat.replace(/\s/g,'')}">${cat}</h2>`;
                groups[cat].forEach(p => {
                    const isPesable = p.Pesable === 'SI';
                    const precioKilo = parseFloat(p.Kilo) || 0;
                    const precioUnit = parseFloat(p.Precio) || 0;

                    const item = document.createElement('div');
                    item.className = 'producto';
                    item.innerHTML = `
                        <img src="${p['URL de la Imagen']}" onerror="this.src='https://via.placeholder.com/100'">
                        <div class="producto-info">
                            <h3>${p['Nombre del Producto']}</h3>
                            <p>${isPesable ? `Kilo: $${precioKilo}` : `Precio: $${precioUnit}`}</p>
                            <div class="producto-actions">
                                ${isPesable ? `
                                    <div class="weight-input-container">
                                        <input type="number" class="weight-input" placeholder="Gramos">
                                        <span>gr.</span>
                                    </div>
                                ` : `
                                    <input type="number" value="1" min="1" style="width:40px;">
                                `}
                                <button onclick="handleAdd('${p['Nombre del Producto'].replace(/'/g, "\\'")}', this)">Agregar</button>
                            </div>
                        </div>
                    `;
                    section.appendChild(item);
                });
                container.appendChild(section);
            }
        }

        function handleAdd(name, btn) {
            const p = allProducts.find(x => x['Nombre del Producto'] === name);
            const input = btn.parentElement.querySelector('input');
            const val = parseFloat(input.value);

            if (p.Pesable === 'SI') {
                if (val >= 10) {
                    const finalPrice = (parseFloat(p.Kilo) / 1000) * val;
                    addToCart(`${p['Nombre del Producto']} (${val}gr)`, finalPrice, 1);
                    input.value = '';
                } else { alert("Ingresa los gramos"); }
            } else {
                addToCart(p['Nombre del Producto'], parseFloat(p.Precio), val);
            }
        }

        function addToCart(name, price, qty) {
            const existing = cart.find(i => i.name === name);
            if (existing) existing.qty += qty;
            else cart.push({ name, price, qty });
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartUI();
            showNotification("¬°Agregado!");
        }

        function updateCartUI() {
            const list = document.getElementById('cart-items');
            list.innerHTML = '';
            let total = 0;
            cart.forEach((item, i) => {
                total += item.price * item.qty;
                const li = document.createElement('li');
                li.style.padding = "10px"; li.style.borderBottom = "1px solid #eee";
                li.innerHTML = `<strong>${item.name}</strong><br>Cant: ${item.qty} - $${(item.price * item.qty).toFixed(2)} 
                <button onclick="remove(${i})" style="float:right; color:red; border:none; background:none;">‚úñ</button>`;
                list.appendChild(li);
            });
            document.getElementById('cart-total').textContent = total.toFixed(2);
            document.getElementById('cart-count').textContent = cart.length;
            document.getElementById('cart-count').style.display = cart.length ? 'flex' : 'none';
        }

        window.remove = (i) => { cart.splice(i,1); localStorage.setItem('cart', JSON.stringify(cart)); updateCartUI(); };

        // --- NAVEGACI√ìN Y QR ---
        document.getElementById('qr-scan-icon').onclick = () => {
            document.getElementById('qr-scanner-container').style.display = 'flex';
            if(!html5QrcodeScanner) html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
            html5QrcodeScanner.render((text) => {
                const found = allProducts.find(p => p['Nombre del Producto'].toLowerCase() === text.trim().toLowerCase());
                if(found) {
                    addToCart(found['Nombre del Producto'], parseFloat(found.Precio), 1);
                    stopQr();
                    showNotification("Escaneado con √©xito");
                }
            });
        };

        function stopQr() { 
            if(html5QrcodeScanner) html5QrcodeScanner.clear(); 
            document.getElementById('qr-scanner-container').style.display = 'none'; 
        }
        document.getElementById('close-qr-scanner').onclick = stopQr;

        document.getElementById('search-icon').onclick = () => {
            const s = document.getElementById('search');
            s.style.display = s.style.display === 'none' ? 'block' : 'none';
        };

        document.getElementById('search').oninput = (e) => {
            const t = e.target.value.toLowerCase();
            const filtered = allProducts.filter(p => p['Nombre del Producto'].toLowerCase().includes(t) || p.Categor√≠a.toLowerCase().includes(t));
            renderProducts(filtered);
        };

        document.getElementById('send-order-button').onclick = () => {
            if(cart.length === 0) return alert("Carrito vac√≠o");
            let msg = "üõçÔ∏è *PEDIDO DIET√âTICA VIRGILIO*\n------------------\n";
            cart.forEach(i => msg += `‚Ä¢ ${i.name} x${i.qty}\n`);
            msg += `------------------\n*TOTAL: $${document.getElementById('cart-total').textContent}*`;
            window.open(`https://wa.me/5491164708681?text=${encodeURIComponent(msg)}`);
        };

        document.getElementById('cart-icon').onclick = () => document.getElementById('cart').style.display = 'flex';
        document.getElementById('close-cart-button').onclick = () => document.getElementById('cart').style.display = 'none';

        function renderCategories() {
            const cats = [...new Set(allProducts.map(p => p.Categor√≠a))];
            const list = document.getElementById('category-list');
            list.innerHTML = '';
            cats.forEach(c => {
                const li = document.createElement('li');
                li.style.padding = "10px"; li.style.borderBottom = "1px solid #eee";
                li.innerHTML = `<a href="#cat-${c.replace(/\s/g,'')}" style="color:black; text-decoration:none; display:block;">${c}</a>`;
                li.onclick = () => document.getElementById('category-menu').style.display = 'none';
                list.appendChild(li);
            });
        }

        document.getElementById('category-icon').onclick = () => {
            const m = document.getElementById('category-menu');
            m.style.display = m.style.display === 'none' ? 'block' : 'none';
        };

        function showNotification(m) {
            const n = document.createElement('div'); n.className = 'notification'; n.textContent = m;
            document.body.appendChild(n); setTimeout(() => n.remove(), 2000);
        }

        document.addEventListener('DOMContentLoaded', checkSecurity);
    </script>
</body>
</html>